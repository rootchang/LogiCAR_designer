---
title: "UMAP visualization of BRCA tumor cells from multiple cohorts and normal tissue cells from HPA"
author: "Tiangen Chang tiangen.chang@nih.gov"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



# Connect to server
```{bash}
ssh changt7@biowulf.nih.gov
sinteractive --mem=512g --cpus-per-task=64 --time=24:00:00
# --gres=lscratch:1024
module load R/
R

```


# load required package
```{r, include=FALSE}

#devtools::install_github("mojaveazure/seurat-disk")
#devtools::install_github('satijalab/seurat-data')
library(SeuratData)
library(SeuratDisk)

library(caret)
library(Seurat)
library(dplyr)
library(ggplot2)
library(dittoSeq)
library(SeuratWrappers)
library(patchwork)
library(RColorBrewer)
library(stringr)
library(tidyr)
library(data.table)

library(harmony)

```

# set input and output directories & parameters
```{r}

# server
data_dir <- paste0('/data/Lab_ruppin/tiangen/CancerProject/08.Sanna_CART/02.Input/')
processed_dir <- paste0('/data/Lab_ruppin/tiangen/CancerProject/08.Sanna_CART/03.Results/')
fig_dir = paste0('/data/Lab_ruppin/tiangen/CancerProject/08.Sanna_CART/03.Results/Figures/')
#surface_genes = read.csv(file = "/data/Lab_ruppin/tiangen/CancerProject/08.Sanna_CART/02.Input/Constants/intersection_and_clinical.txt", header = F)
surface_genes = read.csv(file = "/data/Lab_ruppin/tiangen/CancerProject/08.Sanna_CART/02.Input/Constants/cell_surface_genes_wgene_and_clinical.txt", header = T) # 2786 genes
surface_genes = as.character(surface_genes[,1])

# local
data_dir <- paste0('/Users/changt7/Documents/00.PostDocWork/CancerResearch/01.Projects/00.Collaborating_projects/08.Sanna_CART/02.Data/')
fig_dir = paste0('/Users/changt7/Documents/00.PostDocWork/CancerResearch/01.Projects/00.Collaborating_projects/08.Sanna_CART/03.Results/Figures/')


seurat_files = c(
                 paste0(data_dir,"Stefan_snRNAseq/Multiomics82_Tumor.rds"),
                 paste0(data_dir,"GSE246613/GSE246613_seu_Tissue.rds"),
                 paste0(data_dir,"EMTAB8107/seu_Tissue.rds"),
                 paste0(data_dir,"GSE176078/seu_Tissue.rds"),
                 paste0(data_dir,"Bassez_2021_NatMed/CohortA/seu_Tissue.rds"),
                 paste0(data_dir,"Bassez_2021_NatMed/CohortB/seu_Tissue.rds"),
                 paste0(data_dir,"Wu_2020_EMBO/seu_Tissue.rds"),
                 paste0(data_dir,"GSE161529/seu_Tissue.rds"),
                 paste0(data_dir,"SRP114962/seu_Tissue.rds"),
                 paste0(data_dir,"GSE140819/seu_Tissue.rds"),
                 paste0(data_dir,"GSE148673/seu_Tissue_TISCH.rds"),
                 paste0(data_dir,"GSE150660/seu_Tissue.rds"),
                 paste0(data_dir,"GSE143423/seu_Tissue.rds"),
                 paste0(data_dir,"GSE138536/seu_Tissue.rds"),
                 paste0(data_dir,"GSE118389/seu_Tissue.rds"),
                 paste0(data_dir,"GSE75688/seu_Tissue.rds"),
                 paste0(data_dir,"GSE158724/seu_Tissue.rds")
                 )

dataset_names = c(
                 "Stefan",
                 "GSE246613",
                 "EMTAB8107",
                 "GSE176078",
                 "Bassez_CohortA",
                 "Bassez_CohortB",
                 "Wu",
                 "GSE161529",
                 "SRP114962",
                 "GSE140819",
                 "GSE148673",
                 "GSE150660",
                 "GSE143423",
                 "GSE138536",
                 "GSE118389",
                 "GSE75688",
                 "GSE158724"
                 )

cancerCell_names = list(
                 "Stefan" = c("Tumor"),
                 "GSE246613"= c("Tumor"),
                 "EMTAB8107"= c("Cancer"),
                 "GSE176078"= c("Cancer Epithelial"),
                 "Bassez_CohortA"= c("Cancer_cell"),
                 "Bassez_CohortB"= c("Cancer_cell"),
                 "Wu"= c("Epithelial_Basal", "Epithelial_Basal_Cycling"),
                 "GSE161529"= c("Malignant"),
                 "SRP114962"= c("Malignant"),
                 "GSE140819"= c("Epithelial cell"),
                 "GSE148673"= c("Malignant cells"),
                 "GSE150660"= c("Malignant cells"),
                 "GSE143423"= c("Malignant cells"),
                 "GSE138536"= c("Tumor"),
                 "GSE118389"= c("epithelial"),
                 "GSE75688"= c("Tumor"),
                 "GSE158724"= c("Cancer cells")
                 )

my.colors <- c("#7CD5C8FF", "#507D41FF", "#DF8F44FF", "#6A6599FF", "#CB7C77FF", "#6B42C8FF",
             "#C9D73DFF", "#C555CBFF", "#AED688FF", "#502E71FF", "#C49A3FFF",
             "#42B540FF", "#0099B4FF", "#925E9FFF",
             "#FDAF91FF", "#AD002AFF", "#00468BFF", "#ED0000FF",
             "#6A7DC9FF", "#D7652DFF",
             "#CF4C8BFF", "#5D8D9CFF", "#722E41FF", "#C8B693FF", "#C5383CFF", "#79AF97FF", "#68D359FF", "#3575A1FF")

my.colors <- c(
  "#DC050C", "#FB8072", "#1965B0", "#7BAFDE", "#882E72",
  "#B17BA6", "#FF7F00", "#FDB462", "#E7298A", "#E78AC3",
  "#33A02C", "#B2DF8A", "#55A1B1", "#8DD3C7", "#A6761D",
  "#E6AB02", "#7570B3", "#BEAED4", "#666666", "#999999",
  "#aa8282", "#d4b7b7", "#8600bf", "#ba5ce3", "#808000",
  "#aeae5c", "#1e90ff", "#00bfff", "#56ff0d", "#ffff00",
  "#8B3800", "#4E8500", "#D70131", "#E64B35B2", "#4DBBD5B2",
  "#00A087B2", "#3C5488B2", "#F39B7FB2", "#4E8500", "#4C00FFFF",
  "#000DFFFF", "#0068FFFF", "#00C1FFFF", "#00FF24FF", "#42FF00FF",
  "#A8FF00FF", "#FFF90CFF", "#FFE247FF", "#FFDB83FF", "#4a5b67",
  "#91D1C2B2", "#DC0000B2", "#7E6148B2", "#B09C85B2", "#15b2d3",
  "#236e96", "#ffd700", "#f3872f", "#ff598f", "#4B0082",
  "#00FA9A", "#FFD700", "#9400D3", "#FF4500", "#DA70D6",
  "#8B0000", "#5F9EA0", "#7FFF00", "#6495ED", "#DB7093",
  "#FF6347", "#4682B4", "#FF1493", "#FFDAB9", "#ADFF2F",
  "#006400", "#00CED1", "#800080", "#FF69B4", "#1E90FF",
  "#B22222", "#8B4513", "#A52A2A", "#0000FF", "#00FF7F",
  "#FFB6C1", "#32CD32", "#808080", "#D2691E", "#4169E1",
  "#DAA520", "#FF4500", "#98FB98", "#CD5C5C", "#2F4F4F",
  "#00008B", "#8A2BE2", "#CD853F", "#20B2AA", "#DC143C"
)




my.colors <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00",
               "#CC79A7", "#000000", "#9E0142", "#FEE08B", "#662506", "#67001F",
               "#4DAF4A", "#984EA3", "#FF7F00", "#A6CEE3", "#1F78B4", "#B2DF8A")

my.colors <- c(
  "#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#66A61E", "#E6AB02",
  "#A6761D", "#666666", "#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C",
  "#FB9A99", "#E31A1C", "#FDBF6F", "#FF7F00", "#CAB2D6", "#6A3D9A"
)

my.colors <- c(
    "#FF6F61",  # Bright red
    "#6B5B95",  # Dark purple
    "#88B04B",  # Green-yellow
    "#F7CAC9",  # Pastel pink
    "#92A8D1",  # Soft blue
    "#F37735",  # Orange
    "#00A8CC",  # Cyan blue
    "#A2D729",  # Lime green
    "#4D5645",  # Dark green-gray
    "#FC7193",  # Pink
    "#5B84B1FF",# Sky blue
    "#F3A712",  # Golden yellow
    "#007BA7",  # Blue
    "#D14233",  # Deep red
    "#6C5CE7",  # Bright purple
    "#B5651D",  # Brown
    "#009B77",  # Teal
    "#E67E22"   # Carrot orange
)

my.colors <- c(
  "#A6CEE3", # Light Blue
  "#1F78B4", # Dark Blue
  "#B2DF8A", # Light Green
  "#33A02C", # Dark Green
  "#FB9A99", # Light Red/Pink
  "#E31A1C", # Dark Red
  "#FDBF6F", # Light Orange
  "#FF7F00", # Dark Orange
  "#CAB2D6", # Light Purple
  "#6A3D9A", # Dark Purple
  "#FFFF99", # Pale Yellow
  "#B15928", # Brown
  "#F1BB7B", # Beige
  "#FD6467", # Coral
  "#5B1A18", # Deep Brown/Maroon
  "#D67236", # Burnt Orange
  "#8E6E53", # Taupe
  "#B5AED9"  # Lavender
)

my.colors <- c(
  "#E41A1C", # Bright Red
  "#377EB8", # Bright Blue
  "#4DAF4A", # Green
  "#984EA3", # Purple
  "#FF7F00", # Orange
  "#FFFF33", # Yellow
  "#A65628", # Brown
  "#F781BF", # Pink
  "#999999", # Gray
  "#66C2A5", # Turquoise
  "#FC8D62", # Salmon
  "#8DA0CB", # Light Blue
  "#E78AC3", # Light Pink
  "#A6D854", # Lime Green
  "#FFD92F", # Light Yellow
  "#E5C494", # Beige
  "#7570B3", # Blue-Violet
  "#5B1A18", # Deep Brown/Maroon
  "#8E6E53", # Taupe
  "#CAB2D6", # Light Purple
  "#1B9E77"  # Teal
)


```



# (Run for once only!!) load processed BRCA tumor cells from multiple cohorts (in .rds Seurat object)
# Harmony integration of tumor cells from multiple cohorts based on common cell surface genes
```{r}

######################### (Run only for once!! start) merge datasets and integrate with harmony for only surface genes #########################
seu_list <- list()
# Populate seu_list with Seurat objects
for (fn in seurat_files) {
  print(paste(fn, "in processing ... "))
  seu_list[[fn]] <- readRDS(file = fn)
}
names(seu_list) <- dataset_names
# Print metadata column names for each Seurat object in seu_list
for (fn in names(seu_list)) {
  print(paste("**************", fn, "**************"))
  print(colnames(seu_list[[fn]]@meta.data))
}

for (fn in names(seu_list)) {
  print(paste("**************", fn, "**************"))
  measured_genes = rownames(seu_list[[fn]])
  keep_genes <- intersect(surface_genes, measured_genes)
  print(paste(length(keep_genes), length(measured_genes), dim(seu_list[[fn]])[2]))
}

#### (not need!) remove datasets with too few genes (< 2000 surface genes): 
#### not need to, as genes missed / not detected means expression in all cells = 0
# SRP114962 # "12472 1119" 
# GSE148673 # "19356 1940" 
# GSE150660 # "16034 1491" 
# GSE143423 # "14452 1426" 
# GSE138536 # "25457 1631" 
# 
# # Print cell types for each Seurat object in seu_list
# for (fn in names(seu_list[exclude_names])) {
#   print(paste("**************", fn, "**************"))
#   print(unique(seu_list[[fn]]$cellType))
#   print(dim(seu_list[[fn]]))
# }

#table(seu_list[[2]]$celltype_all)

# exclude_names = c("SRP114962", "GSE148673", "GSE150660", "GSE143423", "GSE138536")
# keep_datasets = setdiff(names(seu_list), exclude_names)
# 
# keep_genes <- surface_genes
# "LILRB4" %in% surface_genes
# keep_genes <- Reduce(intersect, lapply(seu_list[keep_datasets], function(obj) {
#   intersect(keep_genes, rownames(obj))
# }))
# 
# "LILRB4" %in% keep_genes
# clinical_targets = read.csv(file = "/data/Lab_ruppin/tiangen/CancerProject/08.Sanna_CART/02.Input/Constants/solid_indications.txt", sep = "\t", header = T)
# clinical_targets$gene[!(clinical_targets$gene %in% keep_genes)] # "CLDN18" and "ALPP" were not Bassez_CohortA/B; "CEACAM5" was not GSE158724
# clinical_targets$gene[!(clinical_targets$gene %in% surface_genes)] # "AFP","MAGEA1","PTGS2" were intracellular and not included
# 
# for (fn in names(seu_list)) {
#   # Find genes not measured in the Seurat object
#   genes_not_measured <- clinical_targets$gene[!clinical_targets$gene %in% rownames(seu_list[[fn]])]
#   # Print the file name and the genes not measured
#   print(paste(fn, ": ", paste(genes_not_measured, collapse = ", ")))
# }

#a = intersect(keep_genes, rownames(seu_list[["GSE148673"]]))
#length(a)

# -------------------
# 1) Subset each Seurat object by tumor cells only and by the ** surface genes
# -------------------
# Print cell types for each Seurat object in seu_list
for (fn in names(seu_list)) {
  print(paste("**************", fn, "**************"))
  #print(colnames(seu_list[[fn]]@meta.data))
  print(unique(seu_list[[fn]]$cellType))
}
seu_list[["GSE246613"]]$cellType = seu_list[["GSE246613"]]$celltype_all
# Rename the active assay from "originalexp" to "RNA"
seu_list[["GSE246613"]][["RNA"]] <- seu_list[["GSE246613"]][["originalexp"]]
DefaultAssay(seu_list[["GSE246613"]]) <- "RNA"
seu_list[["GSE246613"]][["originalexp"]] <- NULL
Assays(seu_list[["GSE246613"]])

# table(seu_list[["Wu"]]$cellType) # Epithelial_Basal and Epithelial_Basal_Cycling are tumor cells, Epithelial_Luminal_Mature and Myoepithelial are normal cells
# table(seu_list[["GSE161529"]]$cellType) # "Malignant" are tumor cells, "Epithelial" are normal cells
# table(seu_list[["GSE140819"]]$cellType) # "Epithelial cell" are tumor cells
# table(seu_list[["GSE118389"]]$cellType) # "epithelial" are tumor cells

seu_list_sub <- list()
# Iterate through seu_list and filter based on genes and cell types
for (i in names(seu_list)) {
  print(paste("The", i, " dataset is in processing ..."))
  # Get the current Seurat object
  obj <- seu_list[[i]]
  # Keep only the surface genes that exist in the object's features
  keep_genes <- intersect(surface_genes, rownames(obj))
  # Keep only the cells with the specified cell types
  keep_cells <- obj$cellType %in% cancerCell_names[[i]]
  # Subset the Seurat object
  obj_sub <- subset(obj, features = keep_genes)
  obj_sub <- subset(obj_sub, cells = which(keep_cells))
  # Add the subsetted object to the list
  seu_list_sub[[i]] <- obj_sub
}
for (fn in names(seu_list_sub)) {
  print(paste("**************", fn, "**************"))
  print(dim(seu_list_sub[[fn]]))
}

# -------------------
# 2) Normalize & scale each object (if not already done)
# -------------------
seu_list_sub <- lapply(seu_list_sub, function(obj) {
  obj <- NormalizeData(obj)                      # log-normalize by default
  obj <- FindVariableFeatures(obj, nfeatures = 2000)  # pick top variable genes
  obj <- ScaleData(obj)                          # ScaleData() is applied to variable features
  return(obj)
})
# # Rename the active assay from "originalexp" to "RNA"
# seu_list_sub[["GSE246613"]][["RNA"]] <- seu_list_sub[["GSE246613"]][["originalexp"]]
# DefaultAssay(seu_list_sub[["GSE246613"]]) <- "RNA"
# seu_list_sub[["GSE246613"]][["originalexp"]] <- NULL
# Assays(seu_list_sub[["GSE246613"]])

# -------------------
# 3) Merge all objects into one, then run PCA & Harmony
# -------------------
# get the group.by.vars = "orig.ident", or "batch", "patient", etc. for all datasets for Harmony
for (fn in names(seu_list_sub)) {
  print(paste("**************", fn, "**************"))
  seu_list_sub[[fn]]$dataset = fn
  #seu_list_sub[[fn]]
}

# Merge all sub-objects
combined <- merge(seu_list_sub[[1]],
                  y = seu_list_sub[2:length(seu_list_sub)],
                  project = "BRCA_Tumor")
combined
combined <- JoinLayers(combined)

# Set "RNA" as the active assay
DefaultAssay(combined) <- "RNA"

table(combined$dataset)

# Run PCA
combined <- RunPCA(combined, npcs = 30, verbose = FALSE)
saveRDS(combined, file = paste0(data_dir,"seu_integrated_allBRCAdatasets.rds"))


# Suppose your metadata column to integrate on is 'orig.ident' or 'batch' 
# Replace 'orig.ident' below with the actual column name in your data
colnames(combined@meta.data)[grepl("dataset", colnames(combined@meta.data))]
combined <- RunHarmony(
  object = combined,
  group.by.vars = "dataset",  # or orig.ident, "batch", "patient", etc.
  assay.use = "RNA",
  #reduction = "pca"
  dims.use = 1:30
)

# -------------------
# 4) Clustering
# -------------------
# Use the Harmony reduction
combined <- RunUMAP(combined, reduction = "harmony", dims = 1:30)
combined <- FindNeighbors(combined, reduction = "harmony", dims = 1:30)
combined <- FindClusters(combined, resolution = 0.5)
combined$clusters_res0.5 <- combined$seurat_clusters
combined <- FindClusters(combined, resolution = 0.3)
combined$clusters_res0.3 <- combined$seurat_clusters
combined <- FindClusters(combined, resolution = 0.1)
combined$clusters_res0.1 <- combined$seurat_clusters

### merge small clusters (with < 5000 cells) into one 
unique(combined$seurat_clusters)
table(combined$seurat_clusters)
cluster_counts <- table(combined$seurat_clusters)
small_clusters <- names(cluster_counts[cluster_counts < 5000])
### Create a new metadata column, merging small clusters
combined$new_clusters <- ifelse(
  combined$seurat_clusters %in% small_clusters,
  "Small clusters",  # Label for merged small clusters
  as.character(combined$seurat_clusters)  # Keep original cluster names
)
table(combined$new_clusters)

saveRDS(combined, file = paste0(data_dir,"seu_inte_allBRCAdatasets_surfGenes.rds")) # seu_inte_allBRCAdatasets_surfGenes.rds seu_integrated_allBRCAdatasets.rds
######################### (Run only for once!! end ) merge datasets and integrate with harmony ########################


```


# Figure 1E. UMAP visualization of tumor cells from multiple cohorts 
```{r}

seu_combined = readRDS(file = paste0(data_dir,"seu_inte_allBRCAdatasets_surfGenes_old.rds"))
colnames(seu_combined@meta.data)

# -------------------
# 5) UMAP of all tumor cells by datasets
# -------------------
p2 = DimPlot(seu_combined, reduction = "umap", group.by = "dataset", pt.size = 1, alpha = 0.6, label.size = 4,repel = T,label = F, raster=T)+ # NoLegend()+
  scale_color_manual(values = my.colors)+
  labs(x = "UMAP 1", y = "UMAP 2") +  # Set axis labels
  ggtitle("") # repel = TRUE: Ensure labels do not overlap with each other or points; raster = FALSE: Use vector graphics for high-resolution plotting.

ggsave(filename = paste0(fig_dir, "UMAP_allBRCAdatasets_tumorCells_integrated_dataset.png"), plot = p2, height = 120, width = 120*1.5, dpi = 300, units = "mm")


# -------------------
# 6) Identify top markers and annotate clusters
# -------------------

# (a) Find top markers per cluster
Idents(seu_combined) <- "new_clusters"
#Idents(seu_combined) <- "seurat_clusters"

### Convert to factor for consistent ordering
#seu_combined$new_clusters <- factor(seu_combined$new_clusters)

# markers <- FindAllMarkers(
#   seu_combined,
#   assay = "RNA",
#   only.pos = TRUE,
#   logfc.threshold = 0.5, # 0.25
#   min.pct = 0.25
# )
# saveRDS(markers, file = paste0(data_dir,"markers_clusters_integrated_allBRCAdatasets.rds"))
markers <- readRDS(paste0(data_dir,"markers_clusters_integrated_allBRCAdatasets.rds"))

# (b) Select top 1-3 markers for each cluster
top_markers <- markers %>%
  group_by(cluster) %>%
  slice_max(order_by = avg_log2FC, n = 10)  # top N markers
print(top_markers, n = 170)

# (c) Create a named vector (cluster -> annotation) 
#     Just as an example, you might directly match known tumor markers 
#     like EPCAM, HER2, EGFR, etc. Or just use the top_markers approach.

#### simple automatic annotation of clusters
# cluster_ids <- levels(Idents(seu_combined))
# annotation_vec <- setNames(cluster_ids, cluster_ids)  # default same as cluster number
# for(cl in cluster_ids) {
#   # gather the top gene names for that cluster
#   genes_here <- top_markers %>% filter(cluster == cl) %>% pull(gene)
#   annotation_vec[cl] <- paste0(genes_here, collapse = "_")
# }

#### manual annotation of clusters (with top DEGs related to BRCA)
seu_combined$anno_clusters <- seu_combined$new_clusters
map = c(
  "0" = "LY6E+/BST2+/CD24+",
  "1" = "KCNJ3+/PTPRT+/SLC39A6+",
  "2" = "EGFR+/PROM1+/CDH3+",
  "3" = "ERBB2+/ABCC11+/ITGB6+",
  "4" = "TFPI+/F3+/AREG+",
  "5" = "CXCR4+/VTCN1+/CD74+",
  "6" = "PDGFRB+/ITGA11+/ADAM12+",
  "7" = "IGF1R+",
  "8" = "STS+",
  "9" = "ROBO2+",
  "10" = "NTRK2+",
  "11" = "SEMA5A+",
  "12" = "PTPRD+",
  "13" = "ALK+",
  "14" = "CEACAM20+",
  "15" = "TGFA+",
  "16" = "DCC+",
  "Small clusters" = "Small clusters"
)
seu_combined$anno_clusters <- as.character(map[as.character(seu_combined$anno_clusters)])
seu_combined$anno_clusters = factor(seu_combined$anno_clusters, levels = as.character(map))

p2 = DimPlot(seu_combined, reduction = "umap", group.by = "anno_clusters", pt.size = 1, alpha = 0.6, label.size = 4,repel = T,label = F, raster=T)+ # NoLegend()+
  scale_color_manual(values = my.colors)+
  labs(x = "UMAP 1", y = "UMAP 2") +  # Set axis labels
  ggtitle("") # repel = TRUE: Ensure labels do not overlap with each other or points; raster = FALSE: Use vector graphics for high-resolution plotting.

ggsave(filename = paste0(fig_dir, "UMAP_allBRCAdatasets_tumorCells_integrated_annotated.png"), plot = p2, height = 120, width = 120*1.8, dpi = 300, units = "mm")

```

# Figure 5A. UMAP visualization of tumor cells from three TNBC patients respectively
```{r}

seu_combined = readRDS(file = paste0(data_dir,"seu_inte_allBRCAdatasets_surfGenes_old.rds"))
meta_cols <- colnames(seu_combined@meta.data)
"dataset" %in% meta_cols
"PatientID" %in% meta_cols

meta_cols[grepl("atient", meta_cols)]

seu_GSE161529 <- subset(seu_combined, subset = dataset == "GSE161529")
unique(seu_GSE161529$patient_id)
seu_GSE161529_0135 <- subset(seu_GSE161529, subset = patient_id == "patient: 0135")

seu_GSE246613 <- subset(seu_combined, subset = dataset == "GSE246613")
unique(seu_GSE246613$PatientID)
seu_GSE246613_11 <- subset(seu_GSE246613, subset = PatientID == "Patient11")

seu_Bassez_CohortA <- subset(seu_combined, subset = dataset == "Bassez_CohortA")
unique(seu_Bassez_CohortA$patient_id)
seu_Bassez_CohortA_BIOKEY_10 <- subset(seu_Bassez_CohortA, subset = patient_id == "BIOKEY_10")



plot_patient = "GSE161529_0135" # GSE161529_0135  GSE246613_11 Bassez_CohortA_BIOKEY_10

if (plot_patient == "GSE161529_0135"){
  UMAP_plot_seu <- seu_GSE161529_0135
}else if (plot_patient == "GSE246613_11"){
  UMAP_plot_seu <- seu_GSE246613_11
}else if (plot_patient == "Bassez_CohortA_BIOKEY_10"){
  UMAP_plot_seu <- seu_Bassez_CohortA_BIOKEY_10
}



# (a) Find top markers per cluster
Idents(UMAP_plot_seu) <- "new_clusters"
#Idents(UMAP_plot_seu) <- "seurat_clusters"

markers <- readRDS(paste0(data_dir,"markers_clusters_inte_allBRCAdatasets_old.rds"))

# (b) Select top 1-3 markers for each cluster
top_markers <- markers %>%
  group_by(cluster) %>%
  slice_max(order_by = avg_log2FC, n = 10)  # top N markers
print(top_markers, n = 170)

# (c) Create a named vector (cluster -> annotation) 
#     Just as an example, you might directly match known tumor markers 
#     like EPCAM, HER2, EGFR, etc. Or just use the top_markers approach.

#### simple automatic annotation of clusters
# cluster_ids <- levels(Idents(UMAP_plot_seu))
# annotation_vec <- setNames(cluster_ids, cluster_ids)  # default same as cluster number
# for(cl in cluster_ids) {
#   # gather the top gene names for that cluster
#   genes_here <- top_markers %>% filter(cluster == cl) %>% pull(gene)
#   annotation_vec[cl] <- paste0(genes_here, collapse = "_")
# }

#### manual annotation of clusters (with top DEGs related to BRCA)
UMAP_plot_seu$anno_clusters <- UMAP_plot_seu$new_clusters
map = c(
  "0" = "LY6E+/BST2+/CD24+",
  "1" = "KCNJ3+/PTPRT+/SLC39A6+",
  "2" = "EGFR+/PROM1+/CDH3+",
  "3" = "ERBB2+/ABCC11+/ITGB6+",
  "4" = "TFPI+/F3+/AREG+",
  "5" = "CXCR4+/VTCN1+/CD74+",
  "6" = "PDGFRB+/ITGA11+/ADAM12+",
  "7" = "IGF1R+",
  "8" = "STS+",
  "9" = "ROBO2+",
  "10" = "NTRK2+",
  "11" = "SEMA5A+",
  "12" = "PTPRD+",
  "13" = "ALK+",
  "14" = "CEACAM20+",
  "15" = "TGFA+",
  "16" = "DCC+",
  "Small clusters" = "Small clusters"
)
UMAP_plot_seu$anno_clusters <- as.character(map[as.character(UMAP_plot_seu$anno_clusters)])
UMAP_plot_seu$anno_clusters = factor(UMAP_plot_seu$anno_clusters, levels = as.character(map))

p2 = DimPlot(UMAP_plot_seu, reduction = "umap", group.by = "anno_clusters", pt.size = 3, alpha = 1, label.size = 4,repel = T,label = F, raster=T)+ # NoLegend()+
  scale_color_manual(values = my.colors)+
  labs(x = "UMAP 1", y = "UMAP 2") +  # Set axis labels
  ggtitle("") # repel = TRUE: Ensure labels do not overlap with each other or points; raster = FALSE: Use vector graphics for high-resolution plotting.

ggsave(filename = paste0(fig_dir, "UMAP_",plot_patient,"_tumorCells_integrated_annotated.png"), plot = p2, height = 120, width = 120*1.8, dpi = 300, units = "mm")

```



# Figure 1F (old) UMAP visualization of normal tissue cells from HPA
```{r}

seu_HPA = readRDS(file = paste0(data_dir,"/HPA/version24_20241022/seu_HPA_v24.rds"))
colnames(seu_HPA@meta.data)
#unique(seu_HPA$Tissue_grouped)

## tissue and cell groups mapping
tissue_mapping_df = read.table(file = paste0(data_dir,"/HPA/version24_20241022/HPA_scRNAseq_tissue_groups.txt"), sep = "\t", header = T, quote = "", stringsAsFactors = FALSE)
split_tissues <- strsplit(as.character(tissue_mapping_df$tissue_types), ",")
all_tissues <- unlist(split_tissues)
tissue_mapping_expanded <- tissue_mapping_df %>%
  separate_rows(tissue_types, sep = ",") %>%
  mutate(tissue_types = trimws(tissue_types))
tissue_mapping <- setNames(tissue_mapping_expanded$tissue_group, tissue_mapping_expanded$tissue_types)

seu_HPA$Tissue_grouped = as.character(tissue_mapping[seu_HPA$Tissue])
unique(seu_HPA$Tissue_grouped)

cellType_mapping_df = read.table(file = paste0(data_dir,"/HPA/version24_20241022/HPA_scRNAseq_cell_groups.txt"), sep = "\t", header = T, quote = "", stringsAsFactors = FALSE)
split_cellTypes <- strsplit(as.character(cellType_mapping_df$Cell.type), ",")
all_cellTypes <- unlist(split_cellTypes)
cellTypes_mapping_expanded <- cellType_mapping_df %>%
  separate_rows(Cell.type, sep = ",") %>%
  mutate(cell_types = trimws(Cell.type))
cellTypes_mapping <- setNames(cellTypes_mapping_expanded$cell_group, cellTypes_mapping_expanded$cell_types)
cell_order = c("Heart muscle", "Neuronal", "Liver epithelial", "Alveolar", "Urinary epithelial", "Hematopoietic", "Endocrine", "Integumentary",  "Endothelial/vascular",
               "Gastrointestinal epithelial", "Immune", 
               "Female reproductive", "Male reproductive", 
               "Visual", "Skeletal/smooth muscle", "General/glandular epithelial","Glial", "Connective/stromal",
               "Undifferentiated", "Mixed", "Unspecified"
               )

seu_HPA$cell_group_custom = as.character(cellTypes_mapping[seu_HPA$Cell.type])
seu_HPA$cell_group_custom <- factor(seu_HPA$cell_group_custom, levels = cell_order)
unique(seu_HPA$cell_group_custom)


# #### wrong! this is merged from individual tissues, overlap heavily!
# Add UMAP reduction to the Seurat object
# umap_coords <- as.matrix(seu_HPA@meta.data[, c("umap_x", "umap_y")])
# colnames(umap_coords) <- c("UMAP_1", "UMAP_2")  # Rename columns to match Seurat conventions
# 
# seu_HPA[["umap"]] <- CreateDimReducObject(
#   embeddings = umap_coords,
#   key = "UMAP_",
#   assay = DefaultAssay(seu_HPA)
# )

# Normalize the data
seu_HPA <- NormalizeData(seu_HPA) # log(x/sum(x)*10000+1)
# Find highly variable genes
seu_HPA <- FindVariableFeatures(seu_HPA)
# Scale the data
seu_HPA <- ScaleData(seu_HPA) # pbmc <- SCTransform(pbmc, vars.to.regress = "CC.Difference")
# Perform PCA
seu_HPA <- RunPCA(seu_HPA, pc.genes = seu_HPA@var.genes)
# Perform UMAP
seu_HPA <- RunUMAP(seu_HPA, reduction = "pca", dims = 1:30) # separate major cell populations
seu_HPA[["umap_30"]] <- seu_HPA[["umap"]]
seu_HPA <- RunUMAP(seu_HPA, reduction = "pca", dims = 1:10) # separate major cell populations
seu_HPA[["umap_10"]] <- seu_HPA[["umap"]]

saveRDS(seu_HPA, file = paste0(data_dir,"/HPA/version24_20241022/seu_HPA_v24_withUMAP.rds"))


# ############## subsampling, normalize and UMAP, plot ###############
# # Extract metadata and add cell IDs for reference
# metadata <- seu_HPA@meta.data
# metadata$cell_id <- rownames(metadata)  # Add cell IDs
# 
# # Subsample 10% of cells within each unique "Tissue_grouped" value
# set.seed(123)  # Set seed for reproducibility
# sampled_cells <- metadata %>%
#   group_by(Tissue_grouped) %>%
#   sample_frac(0.1) %>%  # Sample 10% of cells within each group
#   pull(cell_id)  # Extract cell IDs
# 
# # Subset the Seurat object using the sampled cells
# seu_HPA_subsampled <- subset(seu_HPA, cells = sampled_cells)
# 
# # Verify the subsampled distribution
# table(seu_HPA_subsampled$Tissue_grouped)
# colnames(seu_HPA_subsampled@meta.data)
# 
# 
# # Step 1: Extract the counts matrix and metadata
# counts_matrix <- seu_HPA_subsampled@assays$RNA@layers$counts
# metadata <- seu_HPA_subsampled@meta.data
# # Ensure the metadata row names match the counts matrix column names
# rownames(metadata) <- colnames(counts_matrix)
# # Step 2: Create a new Seurat object with the counts matrix and metadata
# seu_HPA_subsampled2 <- CreateSeuratObject(
#   counts = counts_matrix,
#   meta.data = metadata
# )
# table(seu_HPA_subsampled2$Tissue_grouped)
# 
# # Normalize the data
# seu_HPA_subsampled <- NormalizeData(seu_HPA_subsampled) # log(x/sum(x)*10000+1)
# 
# # Find highly variable genes
# seu_HPA_subsampled <- FindVariableFeatures(seu_HPA_subsampled)
# 
# # Scale the data
# seu_HPA_subsampled <- ScaleData(seu_HPA_subsampled) # pbmc <- SCTransform(pbmc, vars.to.regress = "CC.Difference")
# 
# # Perform PCA
# seu_HPA_subsampled <- RunPCA(seu_HPA_subsampled, pc.genes = seu_HPA_subsampled@var.genes)
# 
# # Perform UMAP
# seu_HPA_subsampled <- RunUMAP(seu_HPA_subsampled, reduction = "pca", dims = 1:30) # separate major cell populations


colnames(seu_HPA@meta.data)
unique(seu_HPA$Tissue)

p2 = DimPlot(seu_HPA, reduction = "umap", group.by = "Tissue", pt.size = 2, alpha = 1, label.size = 4,repel = T,label = F, raster=T)+ # NoLegend()+
  scale_color_manual(values = my.colors)+
  labs(x = "UMAP 1", y = "UMAP 2") +  # Set axis labels
  ggtitle("") # repel = TRUE: Ensure labels do not overlap with each other or points; raster = FALSE: Use vector graphics for high-resolution plotting.
ggsave(filename = paste0(fig_dir, "UMAP_HPA_scRNAseq_Tissues.png"), plot = p2, height = 120, width = 120*1.8, dpi = 300, units = "mm")


p2 = DimPlot(seu_HPA, reduction = "umap", group.by = "Tissue_grouped", pt.size = 2, alpha = 1, label.size = 4,repel = T,label = F, raster=T)+ # NoLegend()+
  scale_color_manual(values = my.colors)+
  labs(x = "UMAP 1", y = "UMAP 2") +  # Set axis labels
  ggtitle("") # repel = TRUE: Ensure labels do not overlap with each other or points; raster = FALSE: Use vector graphics for high-resolution plotting.
ggsave(filename = paste0(fig_dir, "UMAP_HPA_scRNAseq_groupedTissues.png"), plot = p2, height = 120, width = 120*1.5, dpi = 300, units = "mm")

p2 = DimPlot(seu_HPA, reduction = "umap", group.by = "cell_group_custom", pt.size = 2, alpha = 1, label.size = 4,repel = T,label = F, raster=T)+ # NoLegend()+
  scale_color_manual(values = my.colors)+
  labs(x = "UMAP 1", y = "UMAP 2") +  # Set axis labels
  guides(color = guide_legend(ncol = 1)) + # Force legend into one column
  ggtitle("") # repel = TRUE: Ensure labels do not overlap with each other or points; raster = FALSE: Use vector graphics for high-resolution plotting.
ggsave(filename = paste0(fig_dir, "UMAP_HPA_scRNAseq_groupedCells.png"), plot = p2, height = 120*1.1, width = 120*1.5*1.1, dpi = 300, units = "mm")


```


# Figure 1F (new) cell numbers of 31 tissues
```{r}

# read in data
HPA_cellNums = read.csv(file = "/Users/changt7/Documents/00.PostDocWork/CancerResearch/01.Projects/00.Collaborating_projects/08.Sanna_CART/02.Input/HPA/version24_20241022/rna/rna_single_cell_datasets.tsv", sep = "\t")


# Create the bar plot
pdf(paste0(fig_dir, "HPA_cellNums_Tissues.pdf"), width = 6, height = 3)
ggplot(HPA_cellNums, aes(x = Tissue, y = Cell.count / 1000, fill = Tissue)) +
  geom_bar(stat = "identity") +  # Create bar plot
  labs(
    x = "Tissue",  # X-axis label
    y = "Cell count (thousand cells)",  # Y-axis label with unit
    title = ""  # Plot title
  ) +
    theme(
    panel.grid = element_blank(), 
    panel.background = element_rect(fill = "white"),
    axis.line.y = element_line(color = "black"),
    axis.line.x = element_line(color = "black"),
    axis.ticks.y = element_line(color = "black"),
    axis.ticks.x = element_line(color = "black"),
    axis.text.y = element_text(color = "black"),
    panel.border = element_blank(), 
    axis.text.x = element_text(angle = 50, hjust = 1, color = "black"),  
    legend.position = "none"  # none right
  )+
  scale_fill_manual(values = rainbow(nrow(HPA_cellNums)))  # Use different colors for bars
dev.off()

```


